<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Judul website -->
    <title>ArcGIS Map Gabungan</title>

    <!-- install CDN CSS dan JavaScript-->
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.30/"></script>

    <!-- coustum CSS di sini -->
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #appContainer {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }

      #viewDiv {
        flex: 1;
        width: 100%;
      }

      .container {
        display: flex;
        flex: 1;
        width: 100%;
      }

      #mainDiv {
        padding: 8px;
      }

      #tableDiv {
        height: 100%;
        width: 100%;
      }

      #tableContainer {
        display: none; /* Hide the table container by default */
      }

      #filterContainer {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 2;
      }

      /* #filterContainer.active {
      display: block;
    } */

      .closeButton {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
      }

      #filterField,
      #filterValue {
        width: 45%;
      }

      #filterField {
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <!-- coustum layout element di sini -->
    <div id="appContainer">
      <div id="viewDiv">
        <div id="filterContainer">
          <div class="row">
            <span class="closeButton">X</span>
            <h3>Filter Layer</h3>
            <div class="select-container">
              <select id="filterField"></select>
              <select id="filterValue">
                <option value="">Select value</option>
              </select>
            </div>
            <div class="button-container">
              <button id="resetFilter">Reset Filter</button>
              <button id="applyFilter">Apply Filter</button>
            </div>
          </div>
        </div>
      </div>
      <div id="tableContainer" class="container">
        <div id="tableDiv"></div>
      </div>
    </div>

    <!-- coustum javascript di sini -->
    <script>
      //Instal modul yang diperlukan saja, jangan lupa di load di function
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/FeatureTable",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/widgets/Expand",
        "esri/widgets/BasemapGallery",
        "esri/widgets/Editor",
        "esri/widgets/Search",
        "esri/widgets/Compass",
        "esri/widgets/Fullscreen",
        "esri/widgets/Locate",
        "esri/widgets/Home",
      ], function (
        Map,
        MapView,
        FeatureLayer,
        FeatureTable,
        Legend,
        LayerList,
        Expand,
        BasemapGallery,
        Editor,
        Search,
        Compass,
        Fullscreen,
        Locate,
        Home
      ) {
        const appContainer = document.getElementById("appContainer");
        const tableContainer = document.getElementById("tableContainer");
        const tableDiv = document.getElementById("tableDiv");

        // buat peta beserta basemap tampilan
        const map = new Map({
          basemap: "streets-vector",
        });

        // buat tampilan peta
        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [106.827, -6.175], // Longitude, latitude untuk monas Jakarta
          zoom: 10, //rentang zoom dari (1-23)
        });

        // tambahkan Feature Layer
        const layer_kelurahan = new FeatureLayer({
          url: "https://tataruang.jakarta.go.id/server/rest/services/Hosted/Kependudukan_Jakpus/FeatureServer",
          popupTemplate: {
            title: "POP UP",
            content: getPopupContent,
          }, //layer Kelurahan
        });
        map.add(layer_kelurahan);

        // buat dan tambahkan Attribute Table widget
        const featureTable = new FeatureTable({
          view: view,
          layer: layer_kelurahan,
          container: tableDiv,
        });

        // Tambahkan tombol untuk toggle feature table
        const toggleButton = document.createElement("button");
        toggleButton.innerHTML = '<span class="esri-icon-table"></span>';
        toggleButton.className =
          "esri-widget--button esri-widget esri-interactive";
        toggleButton.onclick = () => {
          if (tableContainer.style.display === "flex") {
            tableContainer.style.display = "none";
          } else {
            tableContainer.style.display = "flex";
          }
        };

        // buat dan tambahkan Layer List (letakan di kanan atas)
        const layerList = new LayerList({
          view: view,
        });

        const expandList = new Expand({
          view: view,
          content: layerList,
          group: "top-right",
          // expanded: true
        });

        // buat dan tambahkan Legenda (letakkan di kanan atas)
        const legend = new Legend({
          view: view,
        });

        const expandLegend = new Expand({
          view: view,
          content: legend,
          group: "top-right",
        });

        // buat dan tambahkan Pemilihan basemap (letakan di kanan atas)
        const basemapGallery = new BasemapGallery({
          view: view,
        });

        const expandBasemap = new Expand({
          view: view,
          content: basemapGallery,
          group: "top-right",
        });

        // Tambahkan tombol untuk toggle filter table
        const filterButton = document.createElement("button");
        filterButton.innerHTML = '<span class="esri-icon-filter"></span>';
        filterButton.className =
          "esri-widget--button esri-widget esri-interactive";
        filterButton.onclick = () => {
          if (filterContainer.style.display === "flex") {
            filterContainer.style.display = "none";
          } else {
            filterContainer.style.display = "flex";
          }
        };

        // Populate filter fields
        layer_kelurahan.when(() => {
          const fields = layer_kelurahan.fields;
          fields.forEach((field) => {
            const filterOption = document.createElement("option");
            filterOption.value = field.name;
            filterOption.text = field.alias || field.name;
            document.getElementById("filterField").appendChild(filterOption);
          });
        });

        // Load filter values when field changes
        document
          .getElementById("filterField")
          .addEventListener("change", () => {
            const selectedField = document.getElementById("filterField").value;
            const filterValueSelect = document.getElementById("filterValue");
            filterValueSelect.innerHTML =
              '<option value="">Select value</option>';

            if (!selectedField) return;

            // Create query to get distinct values for the selected field
            const query = layer_kelurahan.createQuery();
            query.returnDistinctValues = true;
            query.outFields = [selectedField];
            query.orderByFields = [selectedField]; // Ensure order
            layer_kelurahan.queryFeatures(query).then((result) => {
              result.features.forEach((feature) => {
                const value = feature.attributes[selectedField];
                if (value !== null && value !== undefined) {
                  const option = document.createElement("option");
                  option.value = value;
                  option.text = value;
                  filterValueSelect.appendChild(option);
                }
              });
            });
          });

        // Close filter container
        document.querySelector(".closeButton").addEventListener("click", () => {
          document.getElementById("filterContainer").style.display = "none";
        });

        function updateFeatureTable() {
          // Memperbarui tabel atribut dengan data yang terfilter
          featureTable.layer = layer_kelurahan; // Reassign the layer to refresh the table
          featureTable.refresh();
        }

        // Apply filter
        document.getElementById("applyFilter").addEventListener("click", () => {
          const field = document.getElementById("filterField").value;
          const value = document.getElementById("filterValue").value;
          const query = `${field} = '${value}'`;

          layer_kelurahan.definitionExpression = query;
          updateFeatureTable();
          document.getElementById("filterContainer").classList.remove("active");
        });

        // Reset filter
        document.getElementById("resetFilter").addEventListener("click", () => {
          layer_kelurahan.definitionExpression = null;
          updateFeatureTable();
          document.getElementById("filterContainer").classList.remove("active");
        });

        // buat dan tambahkan editor (letakan di kanan atas)
        const editor = new Editor({
          view: view,
          layerInfos: [
            {
              layer: layer_kelurahan,
              formTemplate: {
                elements: [
                  {
                    type: "field",
                    fieldName: "wadmkd",
                    label: "KELURAHAN",
                  },
                  {
                    type: "field",
                    fieldName: "wadmkc",
                    label: "KECAMATAN",
                  },
                ],
              },
            },
          ],
        });

        const expandEditor = new Expand({
          view: view,
          content: editor,
          group: "top-right",
        });

        // buat dan tambahkan search, arah utara, fullscreen (letakan di kiri atas)
        const searchWidget = new Search({
          view: view,
          group: "top-left",
        });

        const expandSearch = new Expand({
          view: view,
          content: searchWidget,
          group: "top-right",
        });

        const compassWidget = new Compass({
          view: view,
          group: "top-left",
        });

        const fullscreen = new Fullscreen({
          view: view,
          group: "top-left",
          element: appContainer,
        });

        // buat dan tambahkan widget locate dan home (sebelah kiri atas/bawah)
        const locate = new Locate({
          view: view,
          group: "top-left",
        });

        const home = new Home({
          view: view,
          group: "top-left",
        });

        // buat dan tambahkan popup
        function getPopupContent(feature) {
          const attributes = feature.graphic.attributes;
          let content = "<table class='popup-table'>";

          content += "<b>Attributes:</b>";
          content += "<table>";
          content += `<tr><td>KELURAHAN</td><td>${attributes.wadmkd}</td></tr>`;
          content += `<tr><td>KECAMATAN</td><td>${attributes.wadmkc}</td></tr>`;
          content += "</table>";

          // buat dan tambahkan attachment
          return feature.graphic.layer
            .queryAttachments({
              objectIds: [attributes[feature.graphic.layer.objectIdField]],
            })
            .then(function (attachmentInfos) {
              if (
                attachmentInfos &&
                attachmentInfos[attributes[feature.graphic.layer.objectIdField]]
                  .length > 0
              ) {
                content +=
                  "<br><b>Attachments:</b><ul class='attachment-preview'>";
                var attachments =
                  attachmentInfos[
                    attributes[feature.graphic.layer.objectIdField]
                  ];
                attachments.forEach(function (attachment) {
                  content += `<li><a href="${attachment.url}" target="_blank">${attachment.name}</a></li>`;
                });
                content += "</ul>";
              }
              return content;
            })
            .catch(function (error) {
              console.error("Error fetching attachments: ", error);
              return content + "<b>No Attachments</b>";
            });
        }

        // ui seluruhnya
        view.ui.add(
          [expandSearch, expandList, expandBasemap, expandLegend, expandEditor],
          "top-right"
        );
        view.ui.add([compassWidget, home, locate, fullscreen], "top-left");
        view.ui.add([toggleButton, filterButton], "bottom-right");
      });
    </script>
  </body>
</html>
